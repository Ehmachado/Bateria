<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bateria do Indicador — Corrigido</title>
<style>
  :root{
    --bg:#1a1f2e; --card:#111827; --text:#e5e7eb; --muted:#9aa4b2;
    --accent:#3b82f6; --accent-2:#22d3ee; --frame:#0f172a; --seg-bg:#1f2937; --cap:#cbd5e1;
    --shadow:0 10px 22px rgba(0,0,0,.24); --radius:20px;
  }
  .theme-blue{ 
    --bg:#d4e3ff; --card:#fff; --text:#0b1220; --muted:#53607a; 
    --accent:#003399; --accent-2:#2a56c6; --frame:#0b1a3a; --seg-bg:#e7ecff; 
    --cap:#c8d2ff; --shadow:0 10px 20px rgba(0,51,153,.16);
  }
  .theme-neon{ 
    --bg:#050a14; --card:#0f172a; --text:#e6f3ff; --muted:#9fb3c8; 
    --accent:#14b8a6; --accent-2:#22d3ee; --frame:#0ea5e9; --seg-bg:#111827; 
    --cap:#94a3b8; --shadow:0 10px 26px rgba(34,211,238,.18);
  }
  .theme-sunset{ 
    --bg:#ffe8d6; --card:#fff; --text:#1f2430; --muted:#7a6a62; 
    --accent:#ef4444; --accent-2:#f59e0b; --frame:#7c2d12; --seg-bg:#ffe9de; 
    --cap:#fecaca; --shadow:0 10px 22px rgba(245,158,11,.18);
  }
  .theme-emerald{ 
    --bg:#d1f4e0; --card:#fff; --text:#112019; --muted:#5b6d63; 
    --accent:#10b981; --accent-2:#34d399; --frame:#064e3b; --seg-bg:#dbf7ea; 
    --cap:#a7f3d0; --shadow:0 10px 22px rgba(16,185,129,.18);
  }
  .theme-mono{ 
    --bg:#e8eaed; --card:#fff; --text:#111827; --muted:#6b7280; 
    --accent:#111827; --accent-2:#6b7280; --frame:#111827; --seg-bg:#eef0f6; 
    --cap:#cbd5e1; --shadow:0 8px 16px rgba(17,24,39,.12);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;margin:0;padding:0}
  body{
    background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center; padding:16px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .wrap{width:100%; max-width:460px}
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); 
    padding:16px; border:1px solid rgba(128,128,128,.15);
    transition: all 0.3s ease;
  }
  header.controls{display:grid; gap:10px; margin-bottom:12px}
  header.controls select, 
  header.controls input{
    width:100%; padding:13px 15px; border-radius:12px; 
    border:1px solid rgba(128,128,128,.2); 
    background:#fff; color:#111827; font-weight:600; font-size:15px;
    transition: border-color 0.2s ease;
  }
  header.controls select:focus,
  header.controls input:focus{
    outline:none; border-color:var(--accent);
  }

  #capture{
    background:var(--card); border:1px solid rgba(128,128,128,.15); 
    border-radius:var(--radius); padding:16px; 
    position:relative;
    transition: all 0.3s ease;
  }
  .title{
    text-align:center; font-weight:800; font-size:clamp(18px,5.5vw,22px); 
    color:var(--accent); margin:0 0 6px;
    transition: color 0.3s ease;
  }
  .sub{
    margin:0 0 10px; text-align:center; font-size:13px; color:var(--muted);
    transition: color 0.3s ease;
  }
  .tag-need{ 
    text-align:center; font-weight:800; font-size:clamp(14px,4.5vw,16px); 
    color:var(--accent-2); margin:14px 0 20px; line-height:1.3;
    transition: color 0.3s ease;
  }

  .battery-container{
    padding-top: 20px;
    margin-bottom: 14px;
  }

  .battery{
    margin:0 auto; width:160px; height:260px;
    position:relative; padding:10px; border-radius:34px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
    border:3px solid var(--frame);
    box-shadow: inset 0 6px 16px rgba(0,0,0,.28), inset 0 -8px 16px rgba(255,255,255,.06);
    transition: border-color 0.3s ease;
  }
  .battery-top{
    position:absolute; top:-15px; left:50%; transform:translateX(-50%);
    width:60px; height:13px; border-radius:18px; 
    background:var(--cap); border:3px solid var(--frame);
    transition: all 0.3s ease;
  }
  .segments{
    position:relative; height:100%; 
    display:flex; flex-direction:column-reverse; gap:6px;
  }
  .seg{
    flex:1;
    border-radius:16px; background:var(--seg-bg); 
    border:2px solid rgba(0,0,0,.08); 
    position:relative; overflow:hidden;
    transition: background-color 0.3s ease;
  }
  .seg .fill{
    position:absolute; inset:0; transform:scaleX(0); transform-origin:left center; 
    transition:transform .4s ease; 
    border-radius:14px;
  }
  .seg .pct{
    position:absolute; inset:0; display:grid; place-items:center; 
    font-weight:800; font-size:12px; color:#fff; 
    text-shadow:0 1px 3px rgba(0,0,0,.5); opacity:.15; 
    transition:opacity .25s ease;
    z-index:2;
  }
  .seg.filled .pct{opacity:1}
  
  .bolt{
    position:absolute; inset:0; display:grid; place-items:center; 
    filter:drop-shadow(0 2px 10px rgba(0,0,0,.35));
    pointer-events:none; z-index:1;
  }
  .bolt svg{
    width:52px; height:auto; opacity:.85; 
    transition: color 0.3s ease;
  }

  .only-done{
    margin-top:8px; text-align:center; font-weight:800; 
    font-size:clamp(15px,5vw,18px); color:var(--accent);
    transition: color 0.3s ease;
  }
  .legend{
    margin-top:8px; text-align:center; font-size:13px; color:var(--muted);
    transition: color 0.3s ease;
  }
  .legend strong{color:var(--text); transition: color 0.3s ease;}

  .mini{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
  .mini input{
    width:100%; padding:13px 15px; border-radius:12px; 
    border:1px solid rgba(128,128,128,.2); 
    background:#fff; color:#111827; font-weight:700; font-size:15px;
    transition: border-color 0.2s ease;
  }
  .mini input:focus{
    outline:none; border-color:var(--accent);
  }

  .actions{
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px;
  }
  .actions button{
    padding:13px 10px; border-radius:12px; border:none; 
    font-weight:800; font-size:14px;
    cursor:pointer; color:#fff; background:var(--accent);
    transition: all 0.15s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  .actions button.secondary{
    background:var(--accent-2); color:#0b1220;
  }
  .actions button:hover{
    transform:translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }
  .actions button:active{
    transform:translateY(0);
    box-shadow: 0 1px 4px rgba(0,0,0,.15);
  }

  #diag{
    margin-top:10px; font-size:13px; color:#10b981; 
    text-align:center; min-height:20px; font-weight:600;
  }
</style>
</head>
<body class="theme-blue">
  <div class="wrap">
    <header class="controls">
      <select id="theme" aria-label="Tema">
        <option value="theme-blue">Tema 1 — Azul</option>
        <option value="theme-neon">Tema 2 — Neon Dark</option>
        <option value="theme-sunset">Tema 3 — Sunset</option>
        <option value="theme-emerald">Tema 4 — Emerald</option>
        <option value="theme-mono">Tema 5 — Mono</option>
      </select>
      <input id="indicador" placeholder="Nome do Indicador" aria-label="Nome do Indicador"/>
    </header>

    <section id="capture" class="card">
      <h1 class="title" id="title">Nec Dia — Seguridade</h1>
      <p class="sub" id="percentTxt">Progresso: 0%</p>

      <div class="tag-need" id="needTop">Nec Dia: R$ 0,00</div>

      <div class="battery-container">
        <div class="battery">
          <div class="battery-top"></div>
          <div class="bolt" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M13.5 2L4 13h6l-1.5 9L21 10h-6l1.5-8z" stroke="currentColor" stroke-width="1.5"/>
            </svg>
          </div>
          <div class="segments" id="segments"></div>
        </div>
      </div>

      <div class="only-done" id="doneBottom">Realizado: R$ 0,00</div>
      <div class="legend" id="legend">
        Falta: <strong>R$ 0,00</strong> • Atualizado às <strong>--:--</strong>
      </div>
    </section>

    <div class="mini">
      <input id="necessidade" inputmode="decimal" placeholder="Nec Dia (R$)" aria-label="Necessidade em Reais"/>
      <input id="realizado" inputmode="decimal" placeholder="Realizado (R$)" aria-label="Realizado em Reais"/>
    </div>

    <div class="actions" role="group" aria-label="Ações">
      <button id="btnUpdate" type="button">Atualizar</button>
      <button id="btnClear" type="button" class="secondary">Limpar</button>
      <button id="btnPNG" type="button">Exportar PNG</button>
    </div>

    <div id="diag" aria-live="polite"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  'use strict';
  
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  
  let state = {
    tema: 'theme-blue',
    indicador: 'Nec Dia — Seguridade',
    necessidade: 0,
    realizado: 0
  };

  function diag(msg) {
    const el = $('#diag');
    if (el) {
      el.textContent = msg;
      if (msg) setTimeout(() => el.textContent = '', 3000);
    }
  }

  function safeLS(action, key, value) {
    try {
      if (action === 'get') return localStorage.getItem(key);
      if (action === 'set') localStorage.setItem(key, value);
      if (action === 'remove') localStorage.removeItem(key);
    } catch(e) { return null; }
  }

  function parseBR(str) {
    if (!str) return 0;
    const s = String(str).replace(/[R$\s]/g, '').trim();
    const hasComma = s.includes(',');
    const hasDot = s.includes('.');
    
    let num = s;
    if (hasComma && hasDot) {
      num = s.replace(/\./g, '').replace(',', '.');
    } else if (hasComma) {
      num = s.replace(',', '.');
    }
    
    const result = parseFloat(num);
    return isNaN(result) ? 0 : result;
  }

  function fmtBRL(v) {
    return v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
  }

  function loadState() {
    state.tema = safeLS('get', 'tema') || 'theme-blue';
    state.indicador = safeLS('get', 'indicador') || 'Nec Dia — Seguridade';
    state.necessidade = parseBR(safeLS('get', 'necessidade'));
    state.realizado = parseBR(safeLS('get', 'realizado'));
  }

  function saveState() {
    safeLS('set', 'tema', state.tema);
    safeLS('set', 'indicador', state.indicador);
    safeLS('set', 'necessidade', state.necessidade);
    safeLS('set', 'realizado', state.realizado);
  }

  function applyTheme(theme) {
    const themes = ['theme-blue', 'theme-neon', 'theme-sunset', 'theme-emerald', 'theme-mono'];
    themes.forEach(t => document.body.classList.remove(t));
    document.body.classList.add(theme);
  }

  function colorFor(i, total) {
    const t = total <= 1 ? 0 : i / (total - 1);
    const h = 0 + (120 * t);
    return `linear-gradient(90deg, hsl(${h} 85% 50%), hsl(${h} 85% 45%))`;
  }

  function buildSegments() {
    const container = $('#segments');
    container.innerHTML = '';
    
    for (let i = 1; i <= 10; i++) {
      const seg = document.createElement('div');
      seg.className = 'seg';
      seg.dataset.index = i;
      
      const fill = document.createElement('div');
      fill.className = 'fill';
      
      const pct = document.createElement('div');
      pct.className = 'pct';
      pct.textContent = `${i * 10}%`;
      
      seg.appendChild(fill);
      seg.appendChild(pct);
      container.appendChild(seg);
    }
  }

  function render() {
    applyTheme(state.tema);
    
    const percent = state.necessidade > 0 ? 
      Math.min(1, Math.max(0, state.realizado / state.necessidade)) : 0;
    const p100 = Math.round(percent * 100);
    
    $('#title').textContent = state.indicador;
    $('#percentTxt').textContent = `Progresso: ${p100}%`;
    $('#needTop').textContent = `Nec Dia: ${fmtBRL(state.necessidade)}`;
    $('#doneBottom').textContent = `Realizado: ${fmtBRL(state.realizado)}`;
    
    const segs = Array.from($$('#segments .seg'));
    const filled = Math.floor(percent * 10);
    const partial = (percent * 10) - filled;
    
    segs.forEach((seg, i) => {
      const fill = seg.querySelector('.fill');
      const pct = seg.querySelector('.pct');
      const segIndex = parseInt(seg.dataset.index);
      
      fill.style.background = colorFor(segIndex - 1, 10);
      
      if (segIndex <= filled) {
        seg.classList.add('filled');
        fill.style.transform = 'scaleX(1)';
        pct.textContent = `${segIndex * 10}%`;
      } else if (segIndex === filled + 1 && partial > 0) {
        seg.classList.add('filled');
        fill.style.transform = `scaleX(${partial})`;
        pct.textContent = `${Math.round(percent * 100)}%`;
      } else {
        seg.classList.remove('filled');
        fill.style.transform = 'scaleX(0)';
        pct.textContent = `${segIndex * 10}%`;
      }
    });
    
    const falta = Math.max(0, state.necessidade - state.realizado);
    const hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    $('#legend').innerHTML = `Falta: <strong>${fmtBRL(falta)}</strong> • Atualizado às <strong>${hora}</strong>`;
    
    saveState();
  }

  function init() {
    loadState();
    buildSegments();
    
    const themeSel = $('#theme');
    const indicador = $('#indicador');
    const inNec = $('#necessidade');
    const inReal = $('#realizado');
    
    themeSel.value = state.tema;
    indicador.value = state.indicador;
    inNec.value = state.necessidade ? String(state.necessidade).replace('.', ',') : '';
    inReal.value = state.realizado ? String(state.realizado).replace('.', ',') : '';
    
    themeSel.addEventListener('change', e => {
      state.tema = e.target.value;
      render();
      diag('✔ Tema alterado');
    });
    
    indicador.addEventListener('input', e => {
      state.indicador = e.target.value || 'Indicador';
      render();
    });
    
    inNec.addEventListener('input', e => {
      state.necessidade = parseBR(e.target.value);
      render();
    });
    
    inReal.addEventListener('input', e => {
      state.realizado = parseBR(e.target.value);
      render();
    });
    
    $('#btnUpdate').addEventListener('click', () => {
      state.necessidade = parseBR(inNec.value);
      state.realizado = parseBR(inReal.value);
      render();
      diag('✔ Atualizado!');
    });
    
    $('#btnClear').addEventListener('click', () => {
      state = {
        tema: 'theme-blue',
        indicador: 'Nec Dia — Seguridade',
        necessidade: 0,
        realizado: 0
      };
      safeLS('remove', 'tema');
      safeLS('remove', 'indicador');
      safeLS('remove', 'necessidade');
      safeLS('remove', 'realizado');
      
      themeSel.value = state.tema;
      indicador.value = state.indicador;
      inNec.value = '';
      inReal.value = '';
      render();
      diag('✔ Limpo!');
    });
    
    $('#btnPNG').addEventListener('click', async () => {
      if (typeof html2canvas !== 'function') {
        diag('❌ html2canvas não disponível');
        return;
      }
      
      try {
        diag('Gerando PNG...');
        
        const captureNode = $('#capture');
        const bgColor = getComputedStyle(document.body).backgroundColor;
        
        const canvas = await html2canvas(captureNode, {
          backgroundColor: bgColor,
          scale: 2,
          useCORS: true,
          logging: false,
          width: captureNode.offsetWidth,
          height: captureNode.offsetHeight
        });
        
        canvas.toBlob(blob => {
          const nome = state.indicador.replace(/[^\w\s-]/g, '').trim() || 'indicador';
          const ts = new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', '-');
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${nome}_${ts}.png`;
          a.click();
          URL.revokeObjectURL(a.href);
          diag('✔ PNG exportado!');
        });
      } catch(e) {
        diag('❌ Erro ao exportar');
        console.error(e);
      }
    });
    
    render();
    diag('✔ Sistema pronto!');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>