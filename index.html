<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bateria Nec dia — Canvas (Autoscale + Simulação Integrado + Sandbox Export)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{
    --title-color:#003399;
    --bg-deep:#0b1220; --bg-1:#151a2b; --bg-2:#1f2336;
    --card:#12172a; --card-bd:#2e3654;
    --text:#eef2ff; --muted:#cbd5ff; --divider:#2e3654;
    --bad:#f87171; --warn:#fbbf24; --good:#34d399;
    --cavity-bottom:#152b2a; --cavity-top:#2c2a46;
    --shell-top:#1a2136; --shell-bottom:#11172a;
  }
  .theme-bbclean{
    --title-color:#003399;
    --bg-deep:#ffffff; --bg-1:#f9fbff; --bg-2:#f2f6ff;
    --card:#ffffff; --card-bd:#e1e7ff; --text:#0b1533; --muted:#1a2a66; --divider:#e1e7ff;
    --bad:#d92d20; --warn:#f59e0b; --good:#15803d;
    --cavity-bottom:#e8edff; --cavity-top:#cdd8ff;
    --shell-top:#ffffff; --shell-bottom:#f4f7ff;
  }
  .theme-midnight{
    --title-color:#9ea5ff;
    --bg-deep:#0b1220; --bg-1:#151a2b; --bg-2:#1f2336;
    --card:#12172a; --card-bd:#2e3654; --text:#eef2ff; --muted:#cbd5ff; --divider:#2e3654;
    --bad:#f87171; --warn:#fbbf24; --good:#34d399;
    --cavity-bottom:#152b2a; --cavity-top:#2c2a46;
    --shell-top:#1a2136; --shell-bottom:#11172a;
  }
  .theme-slate{
    --title-color:#69c0ff;
    --bg-deep:#0f1720; --bg-1:#141c27; --bg-2:#192330;
    --card:#121a24; --card-bd:#2b3746; --text:#eaf2ff; --muted:#bcd0e8; --divider:#2b3746;
    --bad:#fb7185; --warn:#f59e0b; --good:#22c55e;
    --cavity-bottom:#17212e; --cavity-top:#213045;
    --shell-top:#1b2430; --shell-bottom:#111a24;
  }
  .theme-sand{
    --title-color:#f0b24a;
    --bg-deep:#111315; --bg-1:#181b1e; --bg-2:#1e2125;
    --card:#171a1d; --card-bd:#2d3238; --text:#faf8f5; --muted:#e2d8c8; --divider:#2d3238;
    --bad:#ff6b6b; --warn:#f59e0b; --good:#16a34a;
    --cavity-bottom:#2b2620; --cavity-top:#3a3128;
    --shell-top:#222526; --shell-bottom:#16191a;
  }

  *{box-sizing:border-box}
  html,body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#0c1123;color:var(--text)}

  header{max-width:980px;margin:10px auto;padding:0 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .controls{max-width:980px;margin:0 auto 8px;padding:0 10px;display:grid;grid-template-columns:1.2fr .8fr .8fr .6fr .6fr;gap:8px}
  @media (max-width:860px){.controls{grid-template-columns:1fr 1fr}}
  label{font-size:11px;font-weight:800;color:#e5e7eb}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--divider);border-radius:12px;background:#12182b;color:#e5edff;font-size:14px}
  button.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;background:var(--title-color);color:#fff}

  /* ====== ÁREA EXPORTADA (fixa 680×680) ====== */
  #capture{
    width:680px;height:680px;margin:0 auto;border-radius:20px;overflow:hidden;
    border:1px solid var(--divider);
    background:linear-gradient(160deg,var(--bg-deep) 0%,var(--bg-1) 50%,var(--bg-2) 100%);
    position:relative;
    display:grid; place-items:center;
  }

  /* Root escalável (shrink-to-fit) */
  .cap-scale{
    width:680px;height:680px; transform-origin: top left;
    display:grid; grid-template-rows:84px 1fr;
  }

  .cap-top{display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--divider);padding:0 12px}
  .title{display:flex;align-items:center;gap:12px;color:var(--title-color);font-weight:900;font-size:32px;text-align:center;white-space:nowrap;max-width:96%;overflow:hidden;text-overflow:ellipsis}
  .chip{font-size:12px;font-weight:900;color:#0b1220;background:#ffd54d;border:1px solid #ffd54d;border-radius:999px;padding:5px 12px}

  .cap-body{
    display:grid;grid-template-columns:44% 56%;gap:12px;padding:12px;
    align-items:stretch;min-height:0;min-width:0;
  }
  @media (max-width:760px){#capture{width:96vw;height:96vw}}

  .battery-card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--divider);border-radius:14px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:0}
  .battery{width:100%;max-width:320px;aspect-ratio:1/1.95}

  .cards-wrap{display:grid;grid-template-rows:auto 1fr;gap:12px;min-width:0;min-height:0}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  @media (max-width:760px){.cap-body{grid-template-columns:1fr}.cards{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--card-bd);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;min-width:0;min-height:0}
  .k{font-size:12px;font-weight:900;color:var(--muted)}
  .v{font-size:32px;font-weight:900;line-height:1;color:var(--text)}
  .mono{font-variant-numeric:tabular-nums}
  .bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  @media (max-width:460px){.bottom-grid{grid-template-columns:1fr}}
  .prog{grid-column:span 2;background:var(--card);border:1px solid var(--card-bd);border-radius:12px;padding:12px}
  .prog-top{display:flex;justify-content:space-between;align-items:center}
  .bar{height:12px;background:rgba(255,255,255,.06);border:1px solid var(--card-bd);border-radius:999px;overflow:hidden;margin-top:8px}
  .fill{height:100%;width:0%}
  .metric-sm{background:var(--card);border:1px solid var(--card-bd);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
  .metric-sm .k{font-size:12px}.metric-sm .v{font-size:28px}
  .update-card{justify-self:end;align-self:end;background:var(--card);border:1px solid var(--card-bd);border-radius:10px;padding:8px 10px;font-size:12px;color:var(--muted)}

  /* ===== Sandbox invisível para exportação ===== */
  #exportSandbox{
    position:fixed; left:-10000px; top:0;
    width:680px; height:680px;
    overflow:hidden; pointer-events:none; opacity:0; isolation:isolate;
  }
</style>
</head>
<body class="theme-midnight">
  <header>
    <div class="row">
      <label for="theme" style="color:#e5e7eb">Tema:</label>
      <select id="theme">
        <option value="theme-bbclean">BB Clean (claro)</option>
        <option value="theme-midnight" selected>Midnight (escuro)</option>
        <option value="theme-slate">Slate (cinza)</option>
        <option value="theme-sand">Sand (quente)</option>
      </select>
    </div>
    <div class="row">
      <button class="btn" id="btnExport">Exportar PNG</button>
    </div>
  </header>

  <!-- Controles (pré-preenchidos para simulação) -->
  <div class="controls">
    <div><label for="titulo">Título do Produto</label>
      <input id="titulo" type="text" value="Produto Ultra — Seguro Residencial Premium (Nec dia — Campanha Trimestre) — Edição Especial com Texto Muito Comprido Para Simular">
    </div>
    <div><label for="orcado">Orçado (R$)</label>
      <input id="orcado" type="number" step="0.01" min="0" value="1234567.89">
    </div>
    <div><label for="realizado">Realizado (R$)</label>
      <input id="realizado" type="number" step="0.01" min="0" value="345678.90">
    </div>
    <div><label for="warn">% Aviso</label>
      <input id="warn" type="number" min="1" max="99" value="60">
    </div>
    <div><label for="ok">% OK</label>
      <input id="ok" type="number" min="2" max="100" value="95">
    </div>
  </div>

  <!-- ======= ÁREA EXPORTADA ======= -->
  <section id="capture" aria-label="Canvas Exportável">
    <div class="cap-scale" id="capRoot">
      <div class="cap-top">
        <div class="title" id="titleFit">
          <span id="capTitle">Produto Ultra — Seguro Residencial Premium (Nec dia — Campanha Trimestre) — Edição Especial com Texto Muito Comprido Para Simular</span>
          <span class="chip">Nec dia</span>
        </div>
      </div>

      <div class="cap-body">
        <div class="battery-card">
          <div class="battery">
            <svg viewBox="0 0 320 640" width="100%" height="100%" preserveAspectRatio="xMidYMid meet" role="img">
              <defs>
                <linearGradient id="gCavityBg" x1="0" x2="0" y1="1" y2="0">
                  <stop offset="0%" stop-color="var(--cavity-bottom)"/>
                  <stop offset="100%" stop-color="var(--cavity-top)"/>
                </linearGradient>
                <linearGradient id="gShell" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="var(--shell-top)"/>
                  <stop offset="100%" stop-color="var(--shell-bottom)"/>
                </linearGradient>
                <linearGradient id="gLevel" x1="0" x2="0" y1="1" y2="0">
                  <stop offset="0%" stop-color="#ef4444"/>
                  <stop offset="50%" stop-color="#f59e0b"/>
                  <stop offset="100%" stop-color="#16a34a"/>
                </linearGradient>
                <clipPath id="clipCavity"><rect x="64" y="120" width="192" height="420" rx="28" ry="28"/></clipPath>
              </defs>

              <rect x="48" y="96" width="224" height="472" rx="32" fill="url(#gShell)" stroke="var(--divider)" stroke-width="2"/>
              <rect x="128" y="60" width="64" height="28" rx="10" fill="var(--shell-top)" stroke="var(--divider)" stroke-width="2"/>

              <g opacity=".18">
                <rect x="66" y="540" width="188" height="8" rx="4" fill="var(--divider)"/>
                <rect x="66" y="494" width="188" height="8" rx="4" fill="var(--divider)"/>
                <rect x="66" y="448" width="188" height="8" rx="4" fill="var(--divider)"/>
                <rect x="66" y="402" width="188" height="8" rx="4" fill="var(--divider)"/>
                <rect x="66" y="356" width="188" height="8" rx="4" fill="var(--divider)"/>
                <rect x="66" y="310" width="188" height="8" rx="4" fill="var(--divider)"/>
              </g>

              <g clip-path="url(#clipCavity)">
                <rect x="64" y="120" width="192" height="420" fill="url(#gCavityBg)"/>
                <rect id="level" x="64" y="540" width="192" height="0" fill="url(#gLevel)"/>
                <rect x="64" y="120" width="192" height="420" fill="#ffffff" opacity=".06"/>
              </g>
              <rect x="64" y="120" width="192" height="420" rx="28" fill="transparent" stroke="var(--divider)" stroke-width="2"/>
            </svg>
          </div>
        </div>

        <div class="cards-wrap">
          <div class="cards">
            <div class="card"><div class="k">Orçado</div><div class="v mono fit" id="mOrcado">R$ 1.234.567,89</div></div>
            <div class="card"><div class="k">Realizado</div><div class="v mono fit" id="mRealizado">R$ 345.678,90</div></div>
            <div class="card"><div class="k">% Atingimento</div><div class="v mono fit" id="mPct">0%</div></div>
            <div class="card"><div class="k">Status</div><div class="v mono fit" id="mState">—</div></div>
          </div>

          <div class="bottom-grid">
            <div class="prog">
              <div class="prog-top">
                <div class="k">Progresso</div>
                <div class="v mono fit" id="lblPct" style="font-size:28px">0%</div>
              </div>
              <div class="bar"><div class="fill" id="barFill"></div></div>
            </div>

            <div class="metric-sm">
              <div class="k">Restante p/ Meta</div>
              <div class="v mono fit" id="lblRestante">—</div>
            </div>

            <div class="metric-sm">
              <div class="k">Velocidade esperada</div>
              <div class="v mono fit" id="mVE">0%</div>
            </div>

            <div class="metric-sm">
              <div class="k">Falta p/ VE</div>
              <div class="v mono fit" id="mFaltaVE">—</div>
            </div>

            <div class="metric-sm">
              <div class="k">Status vs VE</div>
              <div class="v mono fit" id="mStatus">—</div>
            </div>

            <div class="update-card" id="updateCard">Atualizado às —:—</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sandbox invisível para exportação -->
  <div id="exportSandbox" aria-hidden="true"></div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtBRL = n => isNaN(n) ? '—' : n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const pctTxt = p => isFinite(p) ? `${Math.max(0,Math.min(999,p)).toFixed(1)}%` : '0%';

  const iTitulo = $('#titulo'), iOrcado = $('#orcado'), iRealizado = $('#realizado'), iWarn = $('#warn'), iOk = $('#ok');

  const capRoot = $('#capRoot');
  const capTitle = $('#capTitle');
  const titleFit = $('#titleFit');

  const mOrcado = $('#mOrcado'), mRealizado = $('#mRealizado'), mPct = $('#mPct'), mState = $('#mState');
  const lblPct = $('#lblPct'), barFill = $('#barFill'), lblRestante = $('#lblRestante');
  const mVE = $('#mVE'), mFaltaVE = $('#mFaltaVE'), mStatus = $('#mStatus'), updateCard = $('#updateCard');
  const level = $('#level');

  const CAV_Y=120, CAV_H=420, LEVEL_BASE_Y=CAV_Y+CAV_H, LEVEL_X=64, LEVEL_W=192;

  function fitText(el,max=32,min=12,step=1){
    if(!el) return; el.style.fontSize=max+'px';
    const p=el.parentElement;
    while((el.scrollWidth>p.clientWidth || el.scrollHeight>p.clientHeight*1.2) && max>min){
      max-=step; el.style.fontSize=max+'px';
    }
  }
  function fitAll(){
    $$('.fit').forEach(el=>fitText(el,32,12,1));
    fitText(titleFit,32,16,1);
  }

  function layoutFit(){
    const containerW = 680, containerH = 680;
    capRoot.style.transform = 'scale(1)';
    capRoot.style.left = '0px';
    capRoot.style.top = '0px';

    fitAll();

    const r = capRoot.getBoundingClientRect();
    const k = Math.min(1, containerW / r.width, containerH / r.height);
    capRoot.style.transform = `scale(${k})`;
    const x = (containerW - r.width * k)/2;
    const y = (containerH - r.height * k)/2;
    capRoot.style.position='absolute';
    capRoot.style.left = `${x}px`;
    capRoot.style.top = `${y}px`;
  }

  const horasUteis = (d)=>Math.max(0,Math.min(9,(d.getHours()+d.getMinutes()/60+d.getSeconds()/3600)-9));
  const pctVE = (d)=> (horasUteis(d)/9)*100;
  const themeColor = v => getComputedStyle(document.body).getPropertyValue(v).trim();

  function update(){
    capTitle.textContent = (iTitulo?.value || '').trim() || 'Produto — Simulação';

    const orcado = parseFloat((iOrcado?.value||'').toString().replace(',','.'));
    const realizado = parseFloat((iRealizado?.value||'').toString().replace(',','.'));
    const warn = Math.max(1,Math.min(99,parseFloat(iWarn?.value)||60));
    const ok = Math.max(warn+1,Math.min(100,parseFloat(iOk?.value)||95));

    mOrcado.textContent = fmtBRL(orcado);
    mRealizado.textContent = fmtBRL(realizado);

    const pct = (isFinite(orcado)&&orcado>0) ? (realizado/ orcado)*100 : 0;
    const pctClamp = Math.max(0,Math.min(100,pct));
    mPct.textContent = pctTxt(pct);

    const BAD=themeColor('--bad')||'#ef4444', WARN=themeColor('--warn')||'#f59e0b', GOOD=themeColor('--good')||'#16a34a';

    let stateColor=BAD, stateTxt='Abaixo do ritmo';
    if(pct>=ok){ stateColor=GOOD; stateTxt='Meta no alvo'; }
    else if(pct>=warn){ stateColor=WARN; stateTxt='Em atenção'; }
    mState.textContent=stateTxt; mState.style.color=stateColor; mPct.style.color=stateColor;

    const h=(CAV_H*pctClamp)/100, y=LEVEL_BASE_Y-h;
    level.setAttribute('x',LEVEL_X); level.setAttribute('width',LEVEL_W);
    level.setAttribute('y',y.toFixed(2)); level.setAttribute('height',h.toFixed(2));

    lblPct.textContent=pctTxt(pct);
    barFill.style.width=pctClamp+'%';
    barFill.style.background='linear-gradient(90deg,'+BAD+','+GOOD+')';

    const restante=(isFinite(orcado)&&isFinite(realizado))?Math.max(0,orcado-realizado):NaN;
    lblRestante.textContent=fmtBRL(restante);

    const now=new Date(), ve=pctVE(now);
    mVE.textContent=pctTxt(ve);
    const esperado=isFinite(orcado)? orcado*(ve/100): NaN;
    const faltaVE=(isFinite(esperado)&&isFinite(realizado))? Math.max(0,esperado-realizado):NaN;
    mFaltaVE.textContent=fmtBRL(faltaVE);

    let svTxt='Abaixo da VE', svColor=BAD;
    if(pct>=ve+1){ svTxt='Acima da VE'; svColor=GOOD; }
    else if(Math.abs(pct-ve)<1){ svTxt='No ritmo'; svColor=WARN; }
    mStatus.textContent=svTxt; mStatus.style.color=svColor;

    const p2=n=>String(n).padStart(2,'0');
    updateCard.textContent='Atualizado às '+p2(now.getHours())+':'+p2(now.getMinutes());

    requestAnimationFrame(layoutFit);
  }

  /* ===== Export PNG usando clone isolado no sandbox ===== */
  async function exportPNG(){
    await new Promise(r=>requestAnimationFrame(()=>{ layoutFit(); r(); }));

    const src = document.getElementById('capture');
    const sandbox = document.getElementById('exportSandbox');
    sandbox.innerHTML = '';

    const clone = src.cloneNode(true);
    clone.id = 'captureClone';
    clone.style.width = '680px';
    clone.style.height = '680px';
    clone.style.margin = '0';
    clone.style.borderRadius = src.style.borderRadius || '20px';
    clone.style.transform = 'none';

    const cloneRoot = clone.querySelector('.cap-scale, #capRoot');
    if (cloneRoot){
      cloneRoot.style.transform = 'none';
      cloneRoot.style.left = '0';
      cloneRoot.style.top = '0';
      cloneRoot.style.position = 'relative';
      cloneRoot.style.width = '680px';
      cloneRoot.style.height = '680px';
    }

    sandbox.appendChild(clone);

    const bg = getComputedStyle(document.body).getPropertyValue('--bg-deep').trim() || '#0b1220';
    const canvas = await html2canvas(clone, {
      backgroundColor: bg,
      scale: Math.min(2, window.devicePixelRatio || 2),
      useCORS: true,
      foreignObjectRendering: false,
      width: 680,
      height: 680,
      removeContainer: true
    });

    const raw=(document.getElementById('titulo')?.value||'bateria-nec-dia').toLowerCase();
    const safe=raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'-').replace(/[^\w\-]+/g,'');
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    const name=`${safe}_${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}.png`;

    const blob=await new Promise(res=>canvas.toBlob(res,'image/png'));
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();

    sandbox.innerHTML = '';
  }

  const themeSel = document.getElementById('theme');
  function applyTheme(name){
    document.body.classList.remove('theme-bbclean','theme-midnight','theme-slate','theme-sand');
    document.body.classList.add(name);
    update();
  }
  themeSel.addEventListener('change', e=>applyTheme(e.target.value));

  ['input','change','keyup'].forEach(evt=>{
    ['titulo','orcado','realizado','warn','ok'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener(evt, update);
    });
  });
  document.getElementById('btnExport').addEventListener('click', exportPNG);

  applyTheme(themeSel.value);
  update();
})();
</script>
</body>
</html>